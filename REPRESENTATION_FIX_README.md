# ğŸ”§ Ø¨Ø±Ø·Ø±Ù Ú©Ø±Ø¯Ù† Ù…Ø´Ú©Ù„Ø§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ

## Ù…Ø´Ú©Ù„Ø§Øª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯Ù‡:

### 1. **Ù…Ø´Ú©Ù„ Ø¯Ø± Session Management**
- **Ù…Ø´Ú©Ù„**: Ø¬Ù„Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±Ø³Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ù…ÛŒâ€ŒØ´Ø¯ Ùˆ validation Ø¯Ø±Ø³Øª Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ø±Ø¯
- **Ø±Ø§Ù‡ Ø­Ù„**: 
  - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `start_user_session` Ø¨Ù‡ Ø¬Ø§ÛŒ `update_user_session`
  - Ø¨Ù‡Ø¨ÙˆØ¯ validation Ø¬Ù„Ø³Ù‡ Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ step
  - Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ù„Ø³Ù‡ Ù¾Ø³ Ø§Ø² Ø§ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª

### 2. **Ù…Ø´Ú©Ù„ Ø¯Ø± Error Handling**
- **Ù…Ø´Ú©Ù„**: Ø®Ø·Ø§Ù‡Ø§ Ø¯Ø±Ø³Øª Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…ÛŒâ€ŒØ´Ø¯Ù†Ø¯ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ§Ù… Ù…Ù†Ø§Ø³Ø¨ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ù…ÛŒâ€ŒÚ©Ø±Ø¯
- **Ø±Ø§Ù‡ Ø­Ù„**:
  - Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† try-catch blocks Ú©Ø§Ù…Ù„
  - Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®Ø·Ø§ÛŒ Ø¨Ù‡ØªØ± Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨
  - Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§

### 3. **Ù…Ø´Ú©Ù„ Ø¯Ø± Callback Data**
- **Ù…Ø´Ú©Ù„**: callback_data Ù…Ù…Ú©Ù† Ø¨ÙˆØ¯ Ø®ÛŒÙ„ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨Ø§Ø´Ø¯
- **Ø±Ø§Ù‡ Ø­Ù„**:
  - Ú©ÙˆØªØ§Ù‡ Ú©Ø±Ø¯Ù† timestamp Ø§Ø² 6 Ø±Ù‚Ù… Ø¨Ù‡ 5 Ø±Ù‚Ù…
  - Ø¨Ù‡Ø¨ÙˆØ¯ Ø³Ø§Ø®ØªØ§Ø± callback_data

### 4. **Ù…Ø´Ú©Ù„ Ø¯Ø± Logging**
- **Ù…Ø´Ú©Ù„**: Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ debug Ù†Ø¨ÙˆØ¯
- **Ø±Ø§Ù‡ Ø­Ù„**:
  - Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† print statements Ù…ÙØµÙ„
  - Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ù…Ø±Ø§Ø­Ù„ Ù…Ù‡Ù…
  - Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚

## ØªØºÛŒÛŒØ±Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡:

### 1. **ØªØ§Ø¨Ø¹ `show_representation_request`**
```python
# Ù‚Ø¨Ù„
update_user_session(user_id, 'representation_request')

# Ø¨Ø¹Ø¯
start_user_session(user_id, 'representation_request')
```

### 2. **ØªØ§Ø¨Ø¹ `process_representation_request`**
```python
# Ù‚Ø¨Ù„
if not is_session_valid(user_id):
    bot.send_message(message.chat.id, "â° Ø¬Ù„Ø³Ù‡ Ø´Ù…Ø§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.")
    start(message)
    return

# Ø¨Ø¹Ø¯
session = get_user_session(user_id)
if not session or session.get('step') != 'representation_request':
    markup = create_main_menu()
    bot.send_message(message.chat.id, 
                    "â° Ø¬Ù„Ø³Ù‡ Ø´Ù…Ø§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª ÛŒØ§ Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ Ù‡Ø³ØªÛŒØ¯.\n"
                    "Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.",
                    reply_markup=markup)
    clear_user_session(user_id)
    return
```

### 3. **ØªØ§Ø¨Ø¹ `send_representation_request_to_admin`**
```python
# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† error handling Ú©Ø§Ù…Ù„
try:
    # Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
    sent = bot.send_message(ADMIN_ID, admin_msg, parse_mode="Markdown", reply_markup=markup)
    
    if sent:
        # Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
        print(f"âœ… Representation request sent to admin from user {user_id} with request_id: {request_id}")
    else:
        # Ø­Ø°Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ø§Ú¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯
        if request_id in representation_requests:
            del representation_requests[request_id]
            save_data()
        
        markup = create_main_menu()
        bot.send_message(message.chat.id, 
                       "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª.\n"
                       "Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.",
                       reply_markup=markup)

except Exception as e:
    print(f"âŒ Error sending representation request: {e}")
    
    # Ø­Ø°Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
    if 'request_id' in locals() and request_id in representation_requests:
        del representation_requests[request_id]
        save_data()
    
    markup = create_main_menu()
    bot.send_message(message.chat.id, 
                    "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ.\n"
                    "Ù„Ø·ÙØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.",
                    reply_markup=markup)
```

### 4. **ØªØ§Ø¨Ø¹ `handle_representation_approval`**
```python
# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† logging Ùˆ error handling
try:
    print(f"ğŸ” Processing {action} for request_id: {request_id}")
    
    if request_id not in representation_requests:
        bot.answer_callback_query(call.id, "âŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
        print(f"âŒ Request {request_id} not found in representation_requests")
        return
    
    print(f"âœ… Found request for user {user_id}: {user_info['first_name']} (@{user_info['username']})")
    
    # ... Ú©Ø¯ Ù¾Ø±Ø¯Ø§Ø²Ø´
    
except Exception as e:
    print(f"âŒ Error in handle_representation_approval: {e}")
    bot.answer_callback_query(call.id, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª.")
```

### 5. **ØªØ§Ø¨Ø¹ `process_representation_discount`**
```python
# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† validation Ø¨Ù‡ØªØ± Ùˆ logging
print(f"ğŸ” Processing discount for user {user_id}, request {request_id}")

# Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
if user_id in users_db:
    users_db[user_id]['is_representative'] = True
    users_db[user_id]['representative_discount'] = discount_percent
    users_db[user_id]['representation_date'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    save_data()
    print(f"âœ… User {user_id} marked as representative with {discount_percent}% discount")
else:
    print(f"âŒ User {user_id} not found in users_db")
    bot.send_message(message.chat.id, 
                   "âŒ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯.",
                   reply_markup=types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=1).add(types.KeyboardButton('ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ù†Ù„')))
    return
```

## Ø¯Ø³ØªÙˆØ±Ø§Øª ØªØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡:

### 1. **Ø¯Ø³ØªÙˆØ± `/test_rep`**
- Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ ØªØ³Øª
- Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³ÛŒØ³ØªÙ…

### 2. **Ø¯Ø³ØªÙˆØ± `/clear_test_rep`**
- Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØªØ³Øª
- Ø¨Ø±Ø§ÛŒ ØªÙ…ÛŒØ² Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§Ø¨ÛŒØ³

## Ù†Ø­ÙˆÙ‡ ØªØ³Øª:

1. **ØªØ³Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ**:
   ```
   /test_rep
   ```

2. **Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØªØ³Øª**:
   ```
   /clear_test_rep
   ```

3. **Ø¨Ø±Ø±Ø³ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§**:
   - ØªÙ…Ø§Ù… Ù…Ø±Ø§Ø­Ù„ Ø¯Ø± console Ù„Ø§Ú¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
   - Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ âœ… Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚
   - Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ âŒ Ø¨Ø±Ø§ÛŒ Ø®Ø·Ø§Ù‡Ø§

## Ù†ØªÛŒØ¬Ù‡:

âœ… **Ù…Ø´Ú©Ù„Ø§Øª Ø¨Ø±Ø·Ø±Ù Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯**:
- Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø­Ø§Ù„Ø§ Ø¯Ø±Ø³Øª Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
- Ø®Ø·Ø§Ù‡Ø§ Ø¯Ø±Ø³Øª Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
- Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ debug Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
- Session management Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ Ø§Ø³Øª

ğŸ”§ **Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡**:
1. Ø±Ø¨Ø§Øª Ø±Ø§ restart Ú©Ù†ÛŒØ¯
2. Ø§Ø² Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ "ğŸ¢ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ" Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
3. Ø±ÙˆÛŒ "âœ… Ø¨Ù„Ù‡" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯
4. Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯
5. Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ØªØ£ÛŒÛŒØ¯ ÛŒØ§ Ø±Ø¯ Ú©Ù†Ø¯ 